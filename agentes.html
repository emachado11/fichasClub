<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Agentes â€¢ Club</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/listagem.css">
</head>

<body>

    <main class="pagina-wrapper">

        <header class="pagina-topo agentes-topo">
            <h1>Agentes</h1>
            <a href="criacao_agente.html" class="btn-add">+</a>
        </header>
        <span class="qtd">0 Agentes</span>

        <section class="pagina-container">
            <div class="agentes-grid" id="lista-agentes">

            </div>
        </section>

    </main>

</body>

<script type="module">
    import { auth, db } from "./js/firebase.js";
    import {
        collection,
        getDocs,
        doc,
        getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const lista = document.getElementById("lista-agentes");
    const qtdSpan = document.querySelector(".qtd");

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "login.html";
            return;
        }

        const agentesRef = collection(db, "users", user.uid, "agents");
        const snap = await getDocs(agentesRef);

        qtdSpan.textContent = `${snap.size} Agente${snap.size !== 1 ? "s" : ""}`;

        if (snap.empty) {
            lista.innerHTML = "<p>Nenhum agente criado.</p>";
            return;
        }

        for (const agentSnap of snap.docs) {
            const agente = agentSnap.data();

            let regras = null;

            // ðŸ”— Se o agente estiver numa campanha
            if (agente.campanhaId) {
                const campanhaRef = doc(
                    db,
                    "users",
                    user.uid,
                    "campaigns",
                    agente.campanhaId
                );
                const campanhaSnap = await getDoc(campanhaRef);
                if (campanhaSnap.exists()) {
                    regras = campanhaSnap.data().regrasOpcionais || {};
                }
            }

            const semSanidade = regras?.sem_sanidade;
            const nexExp = regras?.nex_exp;

            const card = document.createElement("div");
            card.className = "agente-card";

            card.innerHTML = `
      <div class="agente-foto"
           style="background-image:url('${agente.foto || ""}')"></div>

      <h2>${agente.nome || "Agente sem nome"}</h2>

      <div class="stats">

        <span>PV ${agente.vida?.atual ?? "--"}/${agente.vida?.max ?? "--"}</span>

        ${semSanidade
                    ? `<span>PD ${agente.determinacao?.atual ?? "--"}/${agente.determinacao?.max ?? "--"}</span>`
                    : `
              <span>SAN ${agente.sanidade?.atual ?? "--"}/${agente.sanidade?.max ?? "--"}</span>
              <span>PE ${agente.esforco?.atual ?? "--"}/${agente.esforco?.max ?? "--"}</span>
            `
                }

        ${nexExp
                    ? `<span>NEX ${agente.nex ?? "--"} â€¢ NÃ­vel ${agente.nivel ?? "--"}</span>`
                    : `<span>NEX ${agente.nex ?? "--"}</span>`
                }

      </div>
    `;

            lista.appendChild(card);
        }
    });
</script>

<script type="module" src="js/header.js"></script>
<script type="module" src="js/auth-guard.js"></script>

</html>